<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.reiko.nail.dao.DenpyoDao">

	<resultMap id="BaseMap" type="com.reiko.nail.entity.DenpyoEntity">
		<id column="DENPYO_NO" property="denpyoNo" />
		<id column="CUSTOMER_CD" property="customerCd" />
		<result column="KOUNYU_DATE" property="kounyuDate" />
		<result column="ZEINUKIGAKU" property="zeinukiGaku" />
		<result column="ZEIGAKU" property="zeiGaku" />
		<result column="ZEIKOMIGAKU" property="zeikomiGaku" />
		<result column="DENPYO_HAKKOZUMI_FLAG" property="denpyoHakkozumiFlag" />
		<result column="BIKO" property="biko" />
		<result column="CREATE_DATE" property="createDate" />
		<result column="UPDATE_DATE" property="updateDate" />
		<result column="HASSOHOHO" property="hassoHoho" />
		<result column="TSUISEKI_NO" property="tsuisekiNo"/>
		<result column="HASSO_DATE" property="hassoDate" />
		<result column="HASSO_RYO" property="hassoRyo" />
  		<result column="DELETE_FLAG" property="deleteFlag" />
	</resultMap>


	

	<select id="selectByAllDenpyoList">
		SELECT 
			denpyo.DENPYO_NO AS denpyoNo,
			denpyo.DENPYO_HAKKOZUMI_FLAG AS denpyoHakkozumiFlag,
			denpyo.KOUNYU_DATE AS kounyuDate,
			denpyo.HASSO_DATE AS hassoDate,
			denpyo.HASSOHOHO AS hassoHoho,
			denpyo.UPDATE_DATE AS updateDate,
			denpyo.ZEIKOMIGAKU AS zeikomiGaku,
			cus.CUSTOMER_SEI AS customerSei,
			cus.CUSTOMER_MEI AS customerMei
		FROM 
			N_DENPYO denpyo
		INNER JOIN 
			CUSTOMER cus
		ON
			denpyo.CUSTOMER_CD = cus.CUSTOMER_CD
		WHERE
			denpyo.DELETE_FLAG = '0'	
		ORDER BY
			denpyo.DENPYO_HAKKOZUMI_FLAG, denpyo.KOUNYU_DATE DESC
	</select>
	
	<select id="countDenpyoMaisu" resultType="int">
		SELECT 
			COUNT(*) 
		FROM 
			N_DENPYO
		WHERE 
			KOUNYU_DATE = #{kounyuDate}
	</select>
	
	<insert id="insertDenpyo">
		INSERT INTO N_DENPYO (
			  DENPYO_NO
			, CUSTOMER_CD
			, KOUNYU_DATE
			, ZEINUKIGAKU
			, ZEIGAKU
			, ZEIKOMIGAKU
			, DENPYO_HAKKOZUMI_FLAG
			, BIKO
			, CREATE_DATE
			, UPDATE_DATE
		) VALUES (
			  #{denpyoNo}
			, #{customerCd}
			, #{kounyuDate}
			, #{zeinukiGaku}
			, #{zeiGaku}
			, #{zeikomiGaku}
			, '0'
			, #{biko}
			, CURRENT_TIMESTAMP
			, CURRENT_TIMESTAMP
		)
	</insert>
	
	<select id="exportDenpyo">
		SELECT 
			denpyo.DENPYO_NO AS denpyoNo,
			denpyo.KOUNYU_DATE AS kounyuDate,
			denpyo.HASSO_DATE AS hassoDate,
			cus.CUSTOMER_SEI AS customerSei,
			cus.CUSTOMER_MEI AS customerMei,
			sale.SHOHIN_CD AS shohinCd,
			sho.ZEIKOMIGAKU AS zeikomiGaku,
			COUNT(sale.SHOHIN_CD) AS suryo,
			sho.ZEIKOMIGAKU * COUNT(sale.SHOHIN_CD) AS shokei
		FROM 
			N_DENPYO denpyo
		INNER JOIN 
			CUSTOMER cus
		ON 
			denpyo.CUSTOMER_CD = cus.CUSTOMER_CD
		LEFT JOIN 
			N_SALES sale
		ON 
			denpyo.DENPYO_NO = sale.DENPYO_NO
		INNER JOIN 
			N_SHOHIN sho
		ON 
			sale.SHOHIN_CD = sho.SHOHIN_CD
		WHERE 
			denpyo.DENPYO_NO = #{denpyoNo}
		AND 
			denpyo.DENPYO_HAKKOZUMI_FLAG = '1'
		AND
			denpyo.DELETE_FLAG = '0'
		GROUP BY 
			sale.SHOHIN_CD, denpyo.HASSO_DATE, denpyo.KOUNYU_DATE, cus.CUSTOMER_SEI, cus.CUSTOMER_MEI
			
	</select>
	
	
	<select id="selectByEditDenpyoForCustomerJoho">
		SELECT 
			denpyo.DENPYO_NO AS denpyoNo,
			denpyo.CUSTOMER_CD AS customerCd,
			denpyo.KOUNYU_DATE AS kounyuDate,
			denpyo.DENPYO_HAKKOZUMI_FLAG AS denpyoHakkozumiFlag,
			cus.CUSTOMER_SEI AS customerSei,
			cus.CUSTOMER_MEI AS customerMei,
			cus.SEI_FURIGANA AS seiFurigana,
			cus.MEI_FURIGANA AS meiFurigana,
			cus.YUBIN_NO AS yubinNo,
			cus.PREFECTURE_CITY AS prefectureCity,
			cus.STREET_NO AS streetNo,
			denpyo.HASSO_DATE AS hassoDate,
			denpyo.BIKO AS biko,
			denpyo.ZEIKOMIGAKU AS gokeiKingaku,
			denpyo.HASSOHOHO AS hassoHoho,
			denpyo.TSUISEKI_NO AS tsuisekiNo,
			denpyo.HASSO_RYO AS hassoRyo
		FROM 
			N_DENPYO denpyo
		INNER JOIN 
			CUSTOMER cus
		ON 
			denpyo.CUSTOMER_CD = cus.CUSTOMER_CD
		LEFT JOIN 
			N_SALES sale
		ON 
			denpyo.DENPYO_NO = sale.DENPYO_NO
		INNER JOIN 
			N_SHOHIN sho
		ON 
			sale.SHOHIN_CD = sho.SHOHIN_CD
		WHERE 
			denpyo.DENPYO_NO = #{denpyoNo}
		AND
			denpyo.DELETE_FLAG = '0'
		GROUP BY 
			denpyo.DENPYO_NO, denpyo.CUSTOMER_CD
	</select>
	
	<select id="selectByEditDenpyoForShohinJoho">
		SELECT 
			sho.SHOHIN_CD AS shohinCd,
			sho.ZEINUKIGAKU AS zeinukiGaku,
			sho.ZEIGAKU AS zeiGaku,
			sho.ZEIKOMIGAKU AS zeikomiGaku
		FROM 
			N_DENPYO denpyo
		INNER JOIN 
			CUSTOMER cus
		ON 
			denpyo.CUSTOMER_CD = cus.CUSTOMER_CD
		LEFT JOIN 
			N_SALES sale
		ON 
			denpyo.DENPYO_NO = sale.DENPYO_NO
		INNER JOIN 
			N_SHOHIN sho
		ON 
			sale.SHOHIN_CD = sho.SHOHIN_CD
		WHERE 
			denpyo.DENPYO_NO = #{denpyoNo}
		AND
			denpyo.DELETE_FLAG = '0'
	</select>
	
	<update id="deleteDenpyoByPrimary">
		UPDATE 
			N_DENPYO
		SET
			DELETE_FLAG = '1'
		WHERE 
			DENPYO_NO = #{denpyoNo}
	</update>
	
	<update id="updateDenpyoByNotKingakuHenko">
		UPDATE
			N_DENPYO
		SET
		  <if test="hassoDate != null || hassoDate != ''">
		  	HASSO_DATE = #{hassoDate},
		  </if>
		  <if test="hassoHoho != null || hassoHoho != ''">
			HASSOHOHO = #{hassoHoho},
		  </if>
		  <if test="tsuisekiNo != null || tsuisekiNo != ''">
			TSUISEKI_NO = #{tsuisekiNo},
		  </if>
		  <if test="hassoRyo != null || hassoRyo != ''">
			HASSO_RYO = #{hassoRyo},
		  </if>
		  <if test="biko != biko || biko !=''">
		  	BIKO = #{biko},
		  </if>
		  DENPYO_HAKKOZUMI_FLAG = #{denpyoHakkozumiFlag},
		  UPDATE_DATE = CURRENT_TIMESTAMP
		WHERE
			DENPYO_NO = #{denpyoNo}
		AND
			DELETE_FLAG = '0'
	</update>
	
	<update id="updateDenpyoByKingakuHenko">
		UPDATE 
			N_DENPYO
		SET
			ZEINUKIGAKU = #{zeinukiGaku},
			ZEIGAKU = #{zeiGaku},
			ZEIKOMIGAKU = #{zeikomiGaku},
		  <if test="hassoDate != null || hassoDate != ''">
		  	HASSO_DATE = #{hassoDate},
		  </if>
		  <if test="hassoHoho != null || hassoHoho != ''">
			HASSOHOHO = #{hassoHoho},
		  </if>
		  <if test="tsuisekiNo != null || tsuisekiNo != ''">
			TSUISEKI_NO = #{tsuisekiNo},
		  </if>
		  <if test="hassoRyo != null || hassoRyo != ''">
			HASSO_RYO = #{hassoRyo},
		  </if>
		  <if test="biko != biko || biko !=''">
		  	BIKO = #{biko},
		  </if>
		  	DENPYO_HAKKOZUMI_FLAG = #{denpyoHakkozumiFlag},
			UPDATE_DATE = CURRENT_TIMESTAMP
		WHERE
			DENPYO_NO = #{denpyoNo}
		AND
			DELETE_FLAG = '0'
	</update>
	
<!-- 	<update id="deleteDenpyoIkkatsu">
		UPDATE
			N_DENPYO
		SET
			DELETE_FLAG = '1'
		WHERE
			DENPYO_NO
	
	
	</update> -->
	
</mapper>