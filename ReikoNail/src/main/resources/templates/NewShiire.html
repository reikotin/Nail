<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="style.css" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="/js/custome.js"></script>
    <title>R-ネイル | 仕入登録</title>
  </head>
<body>
  <div class="container-fluid">
    <div class="row he-1">
        <div th:replace="~{fragments/side :: nav}"></div>
        <main class="col-md-9 ml-sm-auto col-lg-10 bg-light">
          <div class="container r-w">
            <div class="d-flex justify-content-between align-items-center border-bottom border-dark mt-3">
              <h1 class="h1">R-ネイル : 仕入登録</h1><div id="message-container"><span th:if="${message}" th:text="${message}"></span></div>
              <h6 class="">システム日付 : <span id="clock"></span></h6>
            </div>
          </div>
          <div class="d-flex mt-3 mb-3 justify-content-between container r-w">
	        <div class="mt-3 mb-3">
              <button type="submit" id="shiireSearch" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                仕入検索 <i class="bi bi-search"></i>
              </button>    
	        </div>
          </div>
          <div class="container r-w">
			<form th:object="${shiireDto}" id="shiireForm" th:action="@{/SaveShiire}" method="POST">
				<input type="hidden" th:field="*{shiireId}">
				<div class="col-4 d-flex mb-3">
					<div class="col-3 d-flex align-items-center justify-content-center 
					border border-secondary bg-secondary text-white start-rounted">仕入日</div>
					<input type="Date" id="shiireDate" name=shiireDate th:min="${minDate}" class="form-control border border-secondary pe-2 text-center end-rounted">
				</div>
				<div>分類情報</div>
				<div class="d-flex mb-3">
				  <div class="col-4 d-flex">
					<div class="col-3 px-2 d-flex align-items-center justify-content-center 
					border border-secondary bg-secondary text-white start-rounted">大分類</div>
					<select th:field="*{daiBunruiName}" class="form-select border border-secondary text-center no-rounted" required="true">
						<option value="">　</option>
						<option th:each="daiBunrui : ${daiBunruiList}" th:value="${daiBunrui.bunruiName}" th:text="${daiBunrui.bunruiName}" />
						<!--<input type="text" th:field="*{daiBunruiName}" class="form-control-plaintext border border-secondary text-center">-->
					</select>
				  </div>
				  <div class="col-4 d-flex">
					<div class="col-3 px-2 d-flex align-items-center justify-content-center 
					border border-secondary bg-secondary text-white">小分類</div>
					<select th:field="*{shoBunruiName}" class="form-select border border-secondary text-center end-rounted">
						<option value="">  </option>
						<option th:each="shoBunrui : ${shoBunruiList}" th:value="${shoBunrui.bunruiName}" th:text="${shoBunrui.bunruiName}"/>
					</select>
					<!--<input type="text" th:field="*{shoBunruiName}" class="form-control-plaintext border border-secondary text-center end-rounted">-->
				  </div>
				</div>
				<div>商品情報</div>
				<div class="d-flex mb-3">
				  <div class="col-4 d-flex">
					<div class="col-3 px-2 d-flex align-items-center justify-content-center 
					border border-secondary bg-secondary text-white start-rounted">品　名</div>
					<input type="text" th:field="*{itemName}" class="form-control border border-secondary text-center no-rounted">
				  </div>
				  <div class="col-4 d-flex">
					<div class="col-3 px-2 d-flex align-items-center justify-content-center border border-secondary bg-secondary text-white">品　番</div>
					<input type="text" th:field="*{janCd}" class="form-control border border-secondary text-center end-rounted">
				  </div>
				</div>
				<div class="d-flex mb-3">
				  <div class="col-4 d-flex">
					<div class="col-3 px-2 d-flex align-items-center justify-content-center 
					border border-secondary bg-secondary text-white start-rounted">仕入先</div>
					<input type="text" th:field="*{shiireSaki}" class="form-control border border-secondary text-center no-rounted">
				  </div>
				  <div class="col-4 d-flex">
					<div class="col-3 px-2 d-flex align-items-center justify-content-center border border-secondary bg-secondary text-white">メーカー</div>
					<input type="text" th:field="*{shiireMaker}" class="form-control border border-secondary text-center no-rounted">
				  </div>
				  <div class="col-4 d-flex">
					<div class="col-3 px-2 d-flex align-items-center justify-content-center border border-secondary bg-secondary text-white">サイズ</div>
					<input type="text" th:field="*{itemSize}" class="form-control border border-secondary text-center end-rounted">
				  </div>
				</div>
				<div>金額情報</div>
				<div class="d-flex">
	 				<div class="form-check me-3">
					  <input class="form-check-input" type="radio"  value="0" id="zeinukiMode">
					  <label class="form-check-label" for="zeinukiMode">
					    税抜モード
					  </label>
					</div>
	 				<div class="form-check">
					  <input class="form-check-input" type="radio"  value="1" id="zeikomiMode" checked>
					  <label class="form-check-label" for="zeikomiMode">
					    税込モード
					  </label>
					</div>
				</div>
	            <div class="col-4">
					<div class="col d-flex border border-secondary left-top-rounted">
						<div class="col-3 px-2 d-flex align-items-center justify-content-center 
						border-end border-secondary bg-secondary text-white left-top-rounted">税抜額</div>
						<input type="text" th:field="*{zeinukiGaku}" class="form-control text-end pe-2" readonly>
					</div>
					<div class="col d-flex border-start border-end border-secondary">
						<div class="col-3 px-2 d-flex align-items-center justify-content-center border-top border-bottom border-white bg-secondary text-white">税　額</div>
						<input type="text" th:field="*{zeiGaku}" class="form-control text-end pe-2" readonly>
					</div>
	            </div>
				<div class="d-flex mb-3">
					<div class="col-4">
						<div class="col d-flex border border-secondary left-bottom-rounted">
							<div class="col-3 px-2 d-flex align-items-center justify-content-center 
							border-end border-secondary bg-secondary text-white left-bottom-rounted">税込額</div>
							<input type="text" th:field="*{zeikomiGaku}" class="form-control text-end pe-2">
						</div>
					</div>
					<div class="col-4">
					  <div class="col d-flex border border-secondary end-rounted">
				  	    <div class="col-3 px-2 d-flex align-items-center justify-content-center 
				  	    border-end border-secondary bg-secondary text-white">数　量</div>
			      	    <input type="text" th:field="*{suryo}" class="form-control text-end pe-2">
					  </div>
					</div>
				</div>
				<div class="col-4">
				  	<div>
					    <button type="button" id="keisan" class="all-rounted">計算</button>
				    </div>
				</div>
				<div class="d-flex justify-content-end">
					<div class="mt-3 mb-3">
              			<button type="button" id="registerShiire" class="btn btn-primary">登録</button>  
            		</div>
				</div>
			<div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel2" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="staticBackdropLabel"></h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body" id="modal2">
							
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">修正</button>
						</div>
					</div>
				</div>
			</div>
			</form>
				<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
				  <div class="modal-dialog modal-fullscreen">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h1 class="modal-title" id="staticBackdropLabel">仕入検索</h1>
				        <button type="button" class="btn-close boot-btn" data-bs-dismiss="modal" aria-label="Close"></button>
				      </div>
				      <div class="modal-body">
						<div>
							<button type="button" class="btn btn-secondary" id="kensaku">検索</button>
						</div>
						<div class="d-flex searchWindoq">
							<div class="input-group mb-3">
							  <span class="input-group-text">品番／JAN</span>
							  <input type="text" id="searchJan" class="form-control" aria-describedby="basic-addon1">
							</div>
							<div class="input-group mb-3">
							  <span class="input-group-text" id="basic-addon1">仕入商品名</span>
							  <input type="text" id="searchItemName" class="form-control" placeholder="部分一致" aria-describedby="basic-addon1">
							</div>
						</div>
						<div class="d-flex searchWindoq">
							<div class="input-group mb-3">
	  							<label class="input-group-text" for="inputGroupSelect01">　大分類　</label>
	  							<select class="form-select" id="searchDaiBunrui">
									  <option value=''></option>
									  <option th:each="daiBunrui : ${daiBunruiList}" th:value="${daiBunrui.bunruiName}" th:text="${daiBunrui.bunruiName}" />
								 </select>
							</div>
							<div class="input-group mb-3">
	  							<label class="input-group-text" for="inputGroupSelect01">　小分類　</label>
	  							<select class="form-select" id="searchShoBunrui" disabled="true">
								</select>
							</div>
						</div>
			           <table class="table table-bordered text-center">
			              <thead>
			                  <tr>
								  <th>選択</th>
								  <th>品番/JAN</th>
			                      <th>大分類名</th>
			                      <th>小分類名</th>
			                      <th>品名</th>
								  <th>仕入先</th>
			                      <th>メーカー</th>
			                      <th>サイズ</th>
			                      <th>税込額</th>
			                      <th>最終仕入日</th>
			                      <th style="display: none;">仕入ID</th>
			                  </tr>
			              </thead>
			              <tbody id="searchBody">
			              </tbody>
			            </table>
				      </div>
				      <div class="modal-footer">
				        <button type="button" class="btn btn-primary btn-lg" id="resultOk" data-bs-dismiss="modal">OK</button>
				      </div>
				    </div>
				  </div>
				</div>
          </div>          
        </main>
    </div>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
    <script th:inline="javascript">	    
		var message = $('#message-container');
		if(message.innerText !== ''){
	          setTimeout(function () {
	              message.empty(); 
	          }, 5000);
		}

		$(document).ready(function () {
			$('input[type=date]').on('change', function() {
                // 入力がある場合は文字色を黒に、入力がない場合は白に変更
                $(this).css('color', $(this).val() ? 'black' : 'white');
            });
            
            var selectedKeisanMode = '1';
			
            $('#zeinukiMode, #zeikomiMode').on('change', function () {
				selectedKeisanMode = $(this).val();
				console.log(selectedKeisanMode);
				if(selectedKeisanMode === '0'){
					$('#zeinukiMode').prop('checked', true);
					$('#zeikomiMode').prop('checked', false);
					$('#zeikomiGaku').prop('readonly', true);
					$('#zeinukiGaku').prop('readonly', false);
				} else {
					$('#zeinukiMode').prop('checked', false);
					$('#zeikomiMode').prop('checked', true);
					$('#zeikomiGaku').prop('readonly', false);
					$('#zeinukiGaku').prop('readonly', true);
				}
            });
			
			$('#keisan').on('click', function(){
				if(selectedKeisanMode === '1'){
				  var zeikomiGaku = $('#zeikomiGaku').val();
				  var zeinukiGaku = Math.round(zeikomiGaku / 1.1);
				  $('#zeiGaku').val(zeikomiGaku - zeinukiGaku);
				  $('#zeinukiGaku').val(zeinukiGaku);
				} else {
					var zeinukiGaku = $('#zeinukiGaku').val();
					var zeikomiGaku = Math.floor(zeinukiGaku * 1.1);
					$('#zeikomiGaku').val(zeikomiGaku);
					$('#zeiGaku').val(zeikomiGaku - zeinukiGaku);
				}
			});
			
			$('#kensaku').on('click', function(){
				var searchJan =  $('#searchJan').val();
				var searchItemName = $('#searchItemName').val();
				var searchDaiBunrui = $('#searchDaiBunrui').val();
				var searchShoBunrui = $('#searchShoBunrui').val();
				
				var searchShiireDto = {
					janCd: searchJan,
					itemName: searchItemName,
					daiBunruiName: searchDaiBunrui,
					shoBunruiName: searchShoBunrui
				};
				
				$.ajax({
					url: '/SearchShiireItem',
					type: 'GET',
					contentType: "application/json; charset=utf-8",
					dataType: "json",
					data: searchShiireDto,
					success: function(response){
						var tbody = $('#searchBody');
						tbody.empty();
						for(var i = 0; i < response.length; i++){
							var data = response[i];
							
							var newRow = $('<tr>');
							
							var radioCell = $('<td>').html('<input type="radio" name="selectRow" value="' + i + '">').attr('id', 'radioCell_' + i);
							newRow.append(radioCell);
							newRow.append($('<td>').text(data.janCd).attr('id', 'setJanCd_' + i));
							newRow.append($('<td>').text(data.daiBunruiName).attr('id', 'setDaiBunrui_' + i));
							newRow.append($('<td>').text(data.shoBunruiName).attr('id', 'setShoBunrui_' + i));
							newRow.append($('<td>').text(data.itemName).attr('id', 'setItemName_' + i));
							newRow.append($('<td>').text(data.shiireSaki).attr('id', 'setShiireSaki_' +i));
							newRow.append($('<td>').text(data.shiireMaker).attr('id', 'setMaker_' + i));
							newRow.append($('<td>').text(data.itemSize).attr('id', 'setSize_' +i));
							newRow.append($('<td>').text(data.zeikomiGaku).attr('id', 'setZeikomiGaku_' +i));
							newRow.append($('<td>').text(data.shiireDate).attr('id', 'setShiireDate_' +i));
							newRow.append($('<td>').text(data.shiireId).attr('id', 'setShiireId_' +i).css('display', 'none'));	
							tbody.append(newRow);
						}
					}
				});
			});
			
			$('#resultOk').on('click', function(){
				var index = $('input[name="selectRow"]:checked').val();
				
				var dai = $('#setDaiBunrui_' + index).text();
				var sho = $('#setShoBunrui_' + index).text();
				var item = $('#setItemName_' + index).text();
				var jan = $('#setJanCd_' + index).text();
				var saki = $('#setShiireSaki_' + index).text();
				var maker = $('#setMaker_' + index).text();
				var inchi = $('#setSize_' + index).text();
				var zeikomiText = $('#setZeikomiGaku_' + index).text();
				var zeikomi = parseInt(zeikomiText, 10);
				
				var zeinuki = Math.round(zeikomi / 1.1);
				var zei = zeikomi - zeinuki;
				var shiireId = $('#setShiireId_' + index).text();
				
				$('#daiBunruiName').val(dai);
				var selectSho = $('#shoBunruiName');
				var selectbunrui = $('<option>').val(sho).text(sho).prop('selected', true);
				selectSho.append(selectbunrui);
				$('#itemName').val(item);
				$('#janCd').val(jan);
				$('#shiireSaki').val(saki);
				$('#shiireMaker').val(maker);
				$('#itemSize').val(inchi);
				$('#zeinukiGaku').val(zeinuki);
				$('#zeiGaku').val(zei);
				$('#zeikomiGaku').val(zeikomi);
				$('#shiireId').val(shiireId);
			});
			
			$('#daiBunruiName').on('change', function(){
				var selectDaiBunruiName = $(this).val();
				if(selectDaiBunruiName === ''){
					$('#shoBunruiName').prop('disabled', true);
					$('#shoBunruiName').val('');
					return;
				}
				$.ajax({
					url: '/GetShoBunrui',
					type: 'GET',
					data: {
						daiBunruiName : selectDaiBunruiName,
						searchKbn: '3'
						},
					success: function(data){
						updateShoBunruiOptions(data);
					},error: function(){
						
					}
				});
			});
			
			function updateShoBunruiOptions(shoBunruiList) {
				var selectBox = $('#shoBunruiName');
                selectBox.empty();
                if(shoBunruiList.length > 0){
					$('#shoBunruiName').prop('disabled', false);
				}
                for (var i = 0; i < shoBunruiList.length; i++) {
					var option = $('<option>').val(shoBunruiList[i].bunruiName).text(shoBunruiList[i].bunruiName);
                    selectBox.append(option);
                }
             }
             
            $('#registerShiire').on('click', function(){
				var modelMessage = '';
				var suryo = $('#suryo').val();
				var date = $('#shiireDate').val();
				var jan = $('#janCd').val();
				var zeikomi = $('#zeikomiGaku').val();
				var dai = $('#daiBunruiName').val()
				
		        if(suryo === '' || suryo === '0'){
					modelMessage += '・数量が「0」もしくは「空」です。<br>';
				}
				if(date === ''){
					modelMessage += "・仕入日が「空」です。<br>";
				}
				if(jan === ''){
					modelMessage += '・品番が「空」です。<br>';
				}
				if(zeikomi === '' || zeikomi === '0'){
					modelMessage += '・税込額が「0」もしくは「空」です。<br>入力して計算ボタンを押下してください。<br>';
				}
				if(dai === ''){
					modelMessage += '大分類を選択してください。<br>';
				}
		        if (modelMessage !== '') {
		            $('#staticBackdropLabel2').text('以下の項目を修正してください');  
		            $('#modal2').html(modelMessage); 
		            $('#staticBackdrop2').modal('show');
		            return;
		        } else {
		            $('#shiireForm').submit();
		        }
			});
			// 数値以外の入力制御および全角数値の制御
            $('#zeikomiGaku').on('input', function() {
               let inputValue = $(this).val().replace(/[^0-9０-９]/g, '');
               inputValue = inputValue.replace(/[０-９]/g, function(s) {
                 return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
               });
               $(this).val(inputValue);
            });
             
		});
	</script>

</body>
</html>